From 5bc9e0179b66794a87ef871d42036373b59b15b5 Mon Sep 17 00:00:00 2001
From: Elad Nachman <enachman@marvell.com>
Date: Tue, 25 Jan 2022 19:08:04 +0200
Subject: [PATCH 16/40] Import Taras Chornyi net: phylink: Treat speed change
 as a major change

Signed-off-by: Elad Nachman <enachman@marvell.com>
---
 drivers/net/phy/phylink.c | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/drivers/net/phy/phylink.c b/drivers/net/phy/phylink.c
index 2ad4dce717ee..4a77e642fd60 100644
--- a/drivers/net/phy/phylink.c
+++ b/drivers/net/phy/phylink.c
@@ -1542,6 +1542,7 @@ int phylink_ethtool_ksettings_set(struct phylink *pl,
 	__ETHTOOL_DECLARE_LINK_MODE_MASK(support);
 	struct phylink_link_state config;
 	const struct phy_setting *s;
+	bool major_change = false;
 
 	ASSERT_RTNL();
 
@@ -1572,6 +1573,8 @@ int phylink_ethtool_ksettings_set(struct phylink *pl,
 	/* Mask out unsupported advertisements */
 	linkmode_and(config.advertising, kset->link_modes.advertising,
 		     pl->supported);
+	if(kset->base.speed != config.speed)
+		major_change = true;
 
 	/* FIXME: should we reject autoneg if phy/mac does not support it? */
 	switch (kset->base.autoneg) {
@@ -1665,7 +1668,7 @@ int phylink_ethtool_ksettings_set(struct phylink *pl,
 	pl->link_config.duplex = config.duplex;
 	pl->link_config.an_enabled = config.an_enabled;
 
-	if (pl->link_config.interface != config.interface) {
+	if ((pl->link_config.interface != config.interface) || major_change) {
 		/* The interface changed, e.g. 1000base-X <-> 2500base-X */
 		/* We need to force the link down, then change the interface */
 		if (pl->old_link_state) {
-- 
2.17.1

